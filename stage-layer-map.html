<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sealing Pillar Restoration Console</title>
  <meta name="description" content="Amber terminal-style UI (inspired, original composition) - multi-pillar compatible" />
  <style>
    :root{
      --bg:#06080b;
      --panel: rgba(0,0,0,.18);
      --amber:#ffb14a;
      --amber2:#ff8a2a;
      --line: rgba(255,177,74,.55);
      --line2: rgba(255,177,74,.25);
      --line3: rgba(255,177,74,.12);
      --green:#39ff7a;

      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;

      --glow: 0 0 16px rgba(255,177,74,.22);
      --glow2: 0 0 26px rgba(255,177,74,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--amber);
      font-family: var(--mono);
      background:
        radial-gradient(1100px 700px at 50% 20%, rgba(255,177,74,.06), transparent 60%),
        radial-gradient(900px 560px at 30% 60%, rgba(255,177,74,.03), transparent 55%),
        var(--bg);
      letter-spacing:.02em;
      overflow:hidden;
    }

    /* CRT overlay */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(to bottom,
          rgba(255,255,255,.03), rgba(255,255,255,.03) 1px,
          rgba(0,0,0,.00) 2px, rgba(0,0,0,.00) 4px),
        repeating-linear-gradient(90deg,
          rgba(255,177,74,.018), rgba(255,177,74,.018) 1px,
          transparent 2px, transparent 6px),
        radial-gradient(900px 620px at 50% 45%, rgba(255,177,74,.10), transparent 62%);
      mix-blend-mode: screen;
      opacity:.22;
    }
    body::after{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      opacity:.09;
      transform: rotate(.6deg);
    }

    .wrap{
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* scale-to-fit (set by JS) */
    .frame{
      transform: scale(var(--uiScale, 1));
      transform-origin: 50% 50%;
    }

    .frame{
      position:relative;
      border:2px solid var(--line);
      background: linear-gradient(180deg, rgba(255,177,74,.028), transparent 40%), var(--panel);
      box-shadow: 0 26px 100px rgba(0,0,0,.58);
      padding: 12px;
      overflow:hidden;
    }
    .frame::before{
      content:"";
      position:absolute; inset:10px;
      border:1px solid var(--line2);
      pointer-events:none;
    }

    .sideGreen{
      position:absolute;
      left: 8px;
      top: 94px;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      color: var(--green);
      opacity:.86;
      letter-spacing:.10em;
      text-shadow: 0 0 18px rgba(57,255,122,.20);
      user-select:none;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      padding: 2px 4px 10px;
      opacity:.95;
    }
    .topbar .right{display:flex; gap:8px; align-items:center}
    .chip{
      border:1px solid var(--line);
      padding: 2px 10px;
      background: rgba(255,177,74,.06);
      box-shadow: var(--glow);
      font-weight:700;
      letter-spacing:.06em;
      user-select:none;
    }

    .headline{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding: 6px 4px 12px;
      border-bottom:1px solid var(--line2);
      margin-bottom: 12px;
    }
    .h1{
      margin:0;
      font-family: var(--sans);
      font-size: 56px;
      line-height: 1;
      letter-spacing: -0.03em;
      text-shadow: var(--glow2);
    }
    .sub{
      margin:0 0 6px;
      font-size: 12px;
      opacity:.86;
      text-align:right;
      max-width: 520px;
    }

    /* inline config panel (terminal-like) */
    .cfg{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      padding: 10px 4px 12px;
      border-bottom: 1px solid var(--line2);
      margin-bottom: 12px;
      font-size: 12px;
      opacity:.96;
    }
    .cfg label{
      display:flex; gap:8px; align-items:center;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      padding: 6px 8px;
      box-shadow: var(--glow);
    }
    .cfg span{
      font-family: var(--sans);
      font-weight: 800;
      letter-spacing:.02em;
      opacity:.92;
      white-space:nowrap;
    }
    .cfg select, .cfg input{
      appearance:none;
      border:1px solid var(--line2);
      background: rgba(255,177,74,.06);
      color: var(--amber);
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 8px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      min-width: 140px;
    }
    .cfg input[type="number"]{min-width: 96px}
    .cfg .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,177,74,.07);
      color: var(--amber);
      font-family: var(--sans);
      font-weight: 900;
      letter-spacing:.08em;
      padding: 8px 12px;
      box-shadow: var(--glow);
    }
    .cfg .hint{
      opacity:.76;
      white-space:nowrap;
    }

    /* top region layout */
    .topGrid{
      display:grid;
      grid-template-columns: 250px 1fr 250px;
      grid-template-rows: auto auto;
      gap: 12px;
      align-items:stretch;
    }

    .hexBox{
      border:1px solid var(--line);
      background: rgba(255,177,74,.04);
      padding: 10px 10px 8px;
      position:relative;
      overflow:hidden;
      min-height: 92px;
    }
    .hexBox::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(135deg, transparent 0 12px, rgba(255,177,74,.085) 12px 14px, transparent 14px 100%);
      opacity:.6;
      pointer-events:none;
    }
    .hexTitle{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-size: 13px;
      font-weight: 800;
      font-family: var(--sans);
      letter-spacing:.01em;
      text-shadow: var(--glow);
    }
    .hexTitle small{
      font-family: var(--mono);
      font-weight: 700;
      opacity:.82;
      letter-spacing:.03em;
    }
    .hexBits{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:6px 10px;
      font-size: 12px;
      opacity:.92;
    }
    .hexBits code{
      display:block;
      padding: 4px 6px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* radar area */
    .radarWrap{
      grid-column:2;
      grid-row:1 / span 2;
      border:1px solid var(--line);
      background: rgba(255,177,74,.03);
      padding: 12px;
      position:relative;
      overflow:hidden;
      min-height: 540px;
    }
    .radarShell{
      position:relative;
      width: min(620px, 100%);
      aspect-ratio: 1/1;
      margin: 6px auto 0;
    }
    .radarCircle{
      position:absolute; inset:0;
      border:2px solid var(--line);
      border-radius: 50%;
      overflow:hidden;
      box-shadow: inset 0 0 0 1px var(--line2), var(--glow2);
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.62) 0 42%, rgba(0,0,0,0) 43%),
        radial-gradient(circle at 50% 50%, rgba(255,177,74,.06), transparent 64%);
    }
    .radarSvg{
      position:absolute; inset:-2%;
      width:104%;
      height:104%;
      opacity:.95;
    }

    .stageLabel{
      position:absolute;
      font-family: var(--sans);
      font-weight: 900;
      text-shadow: var(--glow2);
      opacity:.95;
      user-select:none;
    }
    .stageSmall{
      position:absolute;
      font-size: 12px;
      opacity:.86;
      user-select:none;
      text-shadow: var(--glow);
    }
    .stageSmall.left{ left: 22px; top: 142px;}
    .stageSmall.right{ right: 22px; top: 142px; text-align:right;}
    .stageL{ left: 22px; top: 176px; font-size: 50px;}
    .stageR{ right: 22px; top: 176px; font-size: 50px; text-align:right;}

    .center{
      position:absolute; inset:0;
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .centerBox{
      width: 54%;
      aspect-ratio: 1/1;
      border-radius: 50%;
      background: rgba(0,0,0,.62);
      box-shadow: inset 0 0 0 1px var(--line2);
      display:grid;
      place-items:center;
      padding: 14px;
    }
    .centerMeta{
      position:absolute;
      top: 44%;
      left:50%;
      transform: translate(-50%,-50%);
      width: 60%;
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      opacity:.92;
    }
    .centerMeta span{
      border:1px solid var(--line2);
      padding: 2px 6px;
      background: rgba(255,177,74,.05);
      box-shadow: var(--glow);
    }

    .stageMid{
      position:absolute;
      top: 32%;
      left: 50%;
      transform: translate(-50%,-50%);
      font-family: var(--sans);
      font-weight: 900;
      font-size: 22px;
      opacity:.92;
      text-shadow: var(--glow2);
      letter-spacing:.02em;
      overflow:hidden;
    }

    .percent{
      font-family: var(--sans);
      font-weight: 950;
      font-size: 92px;
      letter-spacing: -0.03em;
      text-shadow: 0 0 26px rgba(255,177,74,.26);
    }
    .percent small{
      font-size: 34px;
      opacity:.95;
      margin-left: 6px;
    }
    .rank{
      margin-top: 6px;
      font-size: 14px;
      opacity:.86;
    }

    .statusRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 12px 4px 0;
      font-size:12px;
      opacity:.92;
    }

    /* Decryption Key area */
    .sectionTitle{
      margin-top: 12px;
      padding: 10px 6px 6px;
      border-top: 1px solid var(--line2);
      font-family: var(--sans);
      font-size: 48px;
      font-weight: 950;
      letter-spacing:-0.03em;
      text-shadow: var(--glow2);
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .sectionTitle small{
      font-size: 12px;
      font-family: var(--mono);
      font-weight: 800;
      opacity:.86;
      letter-spacing:.02em;
      overflow:hidden;
    }

    .keyArea{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap: 12px;
      padding: 10px 4px 8px;
      border-bottom: 1px solid var(--line2);
      margin-bottom: 10px;
    }

    .progressBox{
      border:1px solid var(--line);
      background: rgba(255,177,74,.03);
      padding: 10px;
      position:relative;
      overflow:hidden;
    }
    .progressBox::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,177,74,.10), transparent 55%);
      opacity:.55;
      pointer-events:none;
    }
    .progressBox .label{font-size: 12px; opacity:.86}
    .progressBox .big{
      font-family: var(--sans);
      font-weight: 950;
      font-size: 56px;
      margin-top: 4px;
      text-shadow: var(--glow2);
    }
    .btnTiny{
      margin-top: 12px;
      display:inline-block;
      padding: 6px 12px;
      border:1px solid var(--line);
      background: rgba(255,177,74,.07);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.08em;
      box-shadow: var(--glow);
      user-select:none;
    }

    .barsWrap{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding: 10px;
      overflow:hidden;
      position:relative;
    }
    .barsHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
      font-size: 12px;
      opacity:.92;
    }

    
    .bars{
      display:flex;
      gap: 0;
      align-items:stretch;
      height: 196px;
      padding: 10px 8px;
      border-top: 1px solid var(--line2);
      border-bottom: 1px solid var(--line2);
      position:relative;
      overflow:hidden;
    }
    .barsPart{
      position:relative;
      flex: 1 1 0;
      height:100%;
    }
    .barsPart + .barsPart{
      border-left: 1px solid rgba(255,177,74,.16);
    }
    .barsGrid{
      position:relative;
      height:100%;
      display:grid;
      gap: 3px;
      align-items:stretch;
      padding: 0 4px;
    }
.bars::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(to bottom,
          rgba(255,177,74,.10), rgba(255,177,74,.10) 1px,
          transparent 1px, transparent 24px);
      opacity:.22;
      pointer-events:none;
    }
    /* two horizontal reference lines */
    .bars::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(to bottom, transparent 33%, rgba(255,177,74,.28) 33.4%, transparent 33.8%),
        linear-gradient(to bottom, transparent 66%, rgba(255,177,74,.28) 66.4%, transparent 66.8%);
      opacity:.55;
      pointer-events:none;
    }

    .slot{
      position:relative;
      height:100%;
    }

    /* "box-and-whisker" cylinder frame */
    .cyl{
      position:absolute;
      left:0; right:0;
      top: 8px;
      height: 180px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.02);
      box-shadow: 0 0 12px rgba(255,177,74,.10);
      touch-action:none;
      user-select:none;
    }
    .cyl.dim{
      opacity:.72;
      background: rgba(0,0,0,.01);
    }
    .cyl .stem{
      position:absolute;
      left:50%;
      top: 16px;
      bottom: 16px;
      width:1px;
      background: rgba(255,177,74,.24);
      transform: translateX(-.5px);
      opacity:.9;
    }
    .cyl .whisker{
      position:absolute;
      left: 18%;
      right: 18%;
      height: 1px;
      background: rgba(255,177,74,.28);
      opacity:.85;
    }
    .cyl .whisker.top{ top: 16px; }
    .cyl .whisker.bottom{ bottom: 16px; }
    .cyl .box{
      position:absolute;
      left: 16%;
      right: 16%;
      height: 36px;
      top: var(--boxY, 50%);
      transform: translateY(-50%);
      border: 1px solid rgba(255,177,74,.36);
      background: rgba(255,177,74,.03);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      cursor: ns-resize;
      touch-action:none;
    }
    .cyl .tick{
      position:absolute;
      left: 0;
      right: 0;
      bottom: 6px;
      display:flex;
      justify-content:space-between;
      gap:2px;
      padding: 0 6%;
      opacity:.35;
      pointer-events:none;
    }
    .cyl .tick i{
      display:block;
      width:1px;
      height: 7px;
      background: rgba(255,177,74,.22);
    }

    .clusters{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 10px 4px 4px;
    }
    .cluster{
      border:1px solid var(--line);
      background: rgba(255,177,74,.03);
      min-height: 92px;
      padding: 8px 10px;
      position:relative;
      overflow:hidden;
    }
    .cluster::before{
      content:"";
      position:absolute; left:0; top:0; right:0; height: 10px;
      background: rgba(255,177,74,.06);
      border-bottom: 1px solid var(--line2);
      opacity:.8;
    }
    .cluster .name{
      font-family: var(--sans);
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.05em;
      margin: 6px 0 6px;
      text-shadow: var(--glow);
    }
    .cluster .state{font-size: 12px; opacity:.90}
    .cluster .tiny{
      position:absolute;
      right: 10px;
      bottom: 8px;
      font-size: 10px;
      opacity:.72;
    }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 8px 4px 2px;
      font-size: 12px;
      opacity:.86;
    }

    @media (max-width: 980px){
      .topGrid{grid-template-columns: 1fr; grid-template-rows:auto;}
      .radarWrap{grid-column:auto; grid-row:auto; min-height:auto}
      .clusters{grid-template-columns: 1fr 1fr}
      .h1{font-size: 46px}
      .sectionTitle{font-size: 40px}
      .cfg label{width: 100%}
      .cfg .hint{width: 100%}
    }
    @media (max-width: 560px){
      .clusters{grid-template-columns: 1fr}
      .keyArea{grid-template-columns: 1fr}
      .percent{font-size: 72px}
    }
      /* === Cinematic + puzzle additions (NORMAL ops style) === */
    .frame{ perspective: 1200px; }

    /* fade-in for radar percent */
    .radarWrap{ transition: opacity .7s ease, transform .7s ease; }
    body.cinematic .radarWrap{ opacity:0; transform: translateY(-10px) scale(.99); }
    body.cinematic.radarShown .radarWrap{ opacity:1; transform: none; }

    .centerBox{ transition: opacity .7s ease, transform .7s ease; }
    body.cinematic .centerBox{ opacity:0; transform: scale(.90); }
    body.cinematic.pctShown .centerBox{ opacity:1; transform: scale(1); }

    /* Decryption tab: rotate in from depth (90deg) */
    .decryptWrap{
      transform-origin: 50% 0%;
      transform: rotateX(90deg) translateY(-14px);
      opacity:0;
      transition: transform .95s cubic-bezier(.2,.8,.2,1), opacity .6s ease;
      will-change: transform, opacity;
    }
    body.cinematic.decryptShown .decryptWrap{
      transform: rotateX(0deg) translateY(0);
      opacity:1;
    }

    /* Keep normal layout when not in cinematic */
    body:not(.cinematic) .decryptWrap{ transform:none; opacity:1; transition:none; }

    .barsHeader .barsRight{ display:flex; gap:10px; align-items:center; justify-content:flex-end; }
    .restartBtn{
      border:1px solid var(--line);
      background: rgba(255,177,74,.10);
      color: var(--amber);
      font-family: var(--sans);
      font-weight: 950;
      letter-spacing:.10em;
      padding: 8px 14px;
      box-shadow: var(--glow);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .restartBtn:disabled{
      opacity:.55;
      cursor:default;
      border-color: rgba(255,177,74,.28);
      box-shadow:none;
    }
    .restartBtn.big{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: min(640px, 86%);
      padding: 14px 18px;
      font-size: 22px;
      letter-spacing:.10em;
      background: rgba(255,255,255,.10);
      border-color: rgba(255,177,74,.55);
      backdrop-filter: blur(2px);
    }
    .restartBtn.big:disabled{ opacity:0; pointer-events:none; }

    .puzzleHud{
      margin-top: 8px;
      font-size: 12px;
      opacity: .90;
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 6px 2px 0;
    }
    
    .clusterUnder{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      border-top: 1px solid var(--line2);
      border-bottom: 1px solid var(--line2);
    }
    .clusterMini{
      position:relative;
      padding: 8px 10px 6px;
      min-height: 60px;
      background: rgba(255,177,74,.02);
      overflow:hidden;
    }
    .clusterMini + .clusterMini{
      border-left: 1px solid rgba(255,177,74,.16);
    }
    .clusterMini::before{
      content:"";
      position:absolute; left:0; top:0; right:0; height: 10px;
      background: rgba(255,177,74,.06);
      border-bottom: 1px solid rgba(255,177,74,.12);
      opacity:.9;
    }
    .clusterMini .name{
      font-family: var(--sans);
      font-weight: 950;
      font-size: 12px;
      letter-spacing:.06em;
      margin: 10px 0 4px;
      text-shadow: var(--glow);
    }
    .clusterMini .state{
      font-size: 12px;
      opacity:.90;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
.puzzleHud b{ font-family: var(--sans); letter-spacing:.04em }

    /* puzzle cylinder states */
    .cyl{ transition: transform .08s linear, filter .2s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease; }
    .cyl.active{
      border-color: rgba(57,255,122,.65);
      box-shadow: 0 0 18px rgba(57,255,122,.18);
      filter: brightness(1.12);
    }
    .cyl.locked{
      border-color: rgba(255,177,74,.78);
      background: linear-gradient(180deg, rgba(255,177,74,.18), rgba(255,177,74,.05));
      opacity:1;
      box-shadow: 0 0 18px rgba(255,177,74,.14);
      filter:none;
    }
    .cyl.locked .box{
      background: rgba(255,177,74,.20);
      border-color: rgba(255,177,74,.65);
    }
    .cyl.locked.dim{ opacity:.92; }


    /* SYSTEM UNLOCKED overlay */
    .unlockOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:0;
      transition: opacity .35s ease;
    }
    .unlockOverlay.on{ opacity:1; pointer-events:auto; }
    .unlockOverlay::before{
      content:"";
      position:absolute; inset:0;
      background: rgba(0,0,0,.35);
    }
    .unlockPanel{
      position:relative;
      width: min(980px, 92%);
      height: min(380px, 52vh);
      background: #c00000;
      border: 2px solid rgba(255,255,255,.45);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .unlockPanel::after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(to bottom,
          rgba(255,255,255,.05), rgba(255,255,255,.05) 1px,
          rgba(255,255,255,0) 2px, rgba(255,255,255,0) 4px);
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .achiral{
      position:absolute;
      top: 16px;
      font-family: var(--sans);
      font-weight: 800;
      font-size: 12px;
      line-height: 1.25;
      color: rgba(255,255,255,.92);
      text-align:center;
      letter-spacing:.02em;
      opacity:.95;
    }
    .achiral b{ font-size: 14px; letter-spacing:.01em }
    .achiral small{ font-weight:700; opacity:.92 }
    .ach1{ left: 18px; }
    .ach2{ left: 50%; transform: translateX(-50%); }
    .ach3{ right: 18px; }

    .unlockMain{ position:relative; z-index:1; text-align:center; padding: 20px; }
    .unlockTitle{
      font-family: var(--sans);
      font-weight: 1000;
      font-size: clamp(40px, 6vw, 86px);
      letter-spacing: -0.03em;
      color: rgba(255,255,255,.95);
      text-shadow: 0 0 24px rgba(0,0,0,.25);
    }
    .unlockSub{
      margin-top: 14px;
      font-family: var(--sans);
      font-weight: 800;
      font-size: clamp(18px, 2.4vw, 34px);
      color: rgba(255,255,255,.90);
      text-shadow: 0 0 18px rgba(0,0,0,.22);
    }
    .unlockFoot{
      position:absolute;
      right: 16px;
      bottom: 12px;
      font-size: 10px;
      color: rgba(255,255,255,.80);
      letter-spacing:.08em;
      z-index:2;
    }

</style>
</head>

<body>
  <main class="wrap">
    <section class="frame">
      <div class="sideGreen" id="sideGreen">L-3E / CONTROL-LINE / ACCESS: RESTRICTED</div>

      <div class="topbar">
        <div id="topbarLeft">AM-4 / SHADING CONTROL / SEALING PILLAR</div>
        <div class="right">
          <span class="chip" id="chipLink">LINK</span>
          <span class="chip">QUIT</span>
        </div>
      </div>

      <header class="headline">
        <h1 class="h1" id="headline">Stage Layer Map</h1>
        <p class="sub" id="subline">RESTORATION SYSTEM CONTROL // NODE INTERLOCK // TELEMETRY FEED</p>
      </header>

      <div class="cfg" aria-label="console configuration">
        <label>
          <span>THEATER</span>
          <select id="theater">
            <option value="EU">EU</option>
            <option value="JP">JP</option>
            <option value="NA">NA</option>
            <option value="SA">SA</option>
            <option value="AF">AF</option>
            <option value="ME">ME</option>
            <option value="OC">OC</option>
            <option value="PAC">PAC</option>
            <option value="GLOBAL">GLOBAL</option>
          </select>
        </label>

        <label>
          <span>PILLAR No.</span>
          <input id="pillarNo" type="number" min="1" max="99" value="1" />
        </label>

        <label>
          <span>MODE</span>
          <select id="mode">
            <option value="RESTORE">RESTORE</option>
            <option value="RESEAL">RE-SEAL</option>
            <option value="STABILIZE">STABILIZE</option>
            <option value="DIAG">DIAG</option>
          </select>
        </label>

        <button class="btn" id="apply">APPLY</button>
        <span class="hint">Tip: URLで固定も可 → <code>?theater=JP&pillar=3&mode=DIAG</code> / Shift+E: Export JSON</span>
      </div>

      <div class="topGrid">
        <div class="hexBox">
          <div class="hexTitle">Hexer 01: Decoding<span><small id="t1">…</small></span></div>
          <div class="hexBits" id="bits1"></div>
        </div>

        <div class="radarWrap">
          <div class="radarShell">
            <div class="radarCircle"></div>

            <svg class="radarSvg" viewBox="-110 -110 220 220" aria-hidden="true">
              <g fill="none" stroke="rgba(255,177,74,.18)" stroke-width="1">
                <path d="M -102 0 A 102 102 0 0 1 102 0" />
                <path d="M -96 0 A 96 96 0 0 1 96 0" />
                <path d="M -90 0 A 90 90 0 0 1 90 0" />
              </g>

              <g fill="none" stroke="rgba(255,177,74,.16)" stroke-width="1">
                <circle r="92"/><circle r="84"/><circle r="76"/><circle r="68"/>
                <circle r="60"/><circle r="52"/><circle r="44"/><circle r="36"/>
                <circle r="28"/><circle r="20"/>
              </g>

              <g stroke="rgba(255,177,74,.18)" stroke-width="1">
                <line x1="0" y1="-96" x2="0" y2="96"/>
                <line x1="-96" y1="0" x2="96" y2="0"/>
                <g opacity=".9">
                  <line x1="24.9" y1="-92.7" x2="-24.9" y2="92.7"/>
                  <line x1="49.6" y1="-82.2" x2="-49.6" y2="82.2"/>
                  <line x1="70.0" y1="-66.0" x2="-70.0" y2="66.0"/>
                  <line x1="84.9" y1="-45.4" x2="-84.9" y2="45.4"/>
                  <line x1="92.7" y1="-24.9" x2="-92.7" y2="24.9"/>

                  <line x1="-24.9" y1="-92.7" x2="24.9" y2="92.7"/>
                  <line x1="-49.6" y1="-82.2" x2="49.6" y2="82.2"/>
                  <line x1="-70.0" y1="-66.0" x2="70.0" y2="66.0"/>
                  <line x1="-84.9" y1="-45.4" x2="84.9" y2="45.4"/>
                  <line x1="-92.7" y1="-24.9" x2="92.7" y2="24.9"/>
                </g>
              </g>

              <g stroke="rgba(255,177,74,.28)" stroke-width="1">
                <line x1="0" y1="-96" x2="0" y2="-88"/>
                <line x1="96" y1="0" x2="88" y2="0"/>
                <line x1="0" y1="96" x2="0" y2="88"/>
                <line x1="-96" y1="0" x2="-88" y2="0"/>
              </g>

              <g fill="rgba(255,177,74,.55)" font-family="ui-monospace, Menlo, Consolas, monospace" font-size="8" text-anchor="middle">
                <text x="0" y="-102">0</text>
                <text x="52" y="-88">15</text>
                <text x="88" y="-52">30</text>
                <text x="102" y="0">45</text>
                <text x="88" y="56">60</text>
                <text x="52" y="92">75</text>
                <text x="0" y="106">90</text>
                <text x="-52" y="92">105</text>
                <text x="-88" y="56">120</text>
                <text x="-102" y="0">135</text>
                <text x="-88" y="-52">150</text>
                <text x="-52" y="-88">165</text>
              </g>

              <defs>
                <linearGradient id="w" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0" stop-color="rgba(255,177,74,.00)"/>
                  <stop offset="1" stop-color="rgba(255,177,74,.10)"/>
                </linearGradient>
              </defs>
              <path id="sweep" d="M0,0 L0,-98 A98,98 0 0,1 45,-87 Z" fill="url(#w)" opacity=".9"/>
            </svg>

            <div class="stageSmall left">STAGE</div>
            <div class="stageLabel stageL" id="stageLeft">04</div>
            <div class="stageSmall right">STAGE</div>
            <div class="stageLabel stageR" id="stageRight">05</div>

            <div class="center">
              <div class="centerBox">
                <div class="stageMid" id="stageMid">STAGE 04</div>
                <div class="centerMeta">
                  <span id="secTag">SEC-10</span>
                  <span id="sideTag">SIDE-B</span>
                </div>
                <div class="percent"><span id="pct">037</span><small>%</small></div>
                <div class="rank">RANK <b id="rank">C</b></div>
              </div>
            </div>
          </div>

          <div class="statusRow">
            <span class="chip" id="statusLeft">INTERLINK: NOMINAL</span>
            <span class="chip" id="statusRight" style="opacity:.86;border-color:rgba(255,177,74,.38)">AI SYSTEMS: LOCKED</span>
          </div>
        </div>

        <div class="hexBox">
          <div class="hexTitle">Hexer 02: Decoding<span><small id="t2">…</small></span></div>
          <div class="hexBits" id="bits2"></div>
        </div>

        <div class="hexBox">
          <div class="hexTitle">Hexer 03: Decoding<span><small id="t3">…</small></span></div>
          <div class="hexBits" id="bits3"></div>
        </div>

        <div class="hexBox">
          <div class="hexTitle">Hexer 04: Decoding<span><small id="t4">…</small></span></div>
          <div class="hexBits" id="bits4"></div>
        </div>
      </div>

            <div id="decryptWrap" class="decryptWrap">

      <div class="sectionTitle">
        Decryption Key
        <small id="keyMeta">BLACK VAULT / THEATER EU / SEALING PILLAR No.01</small>
      </div>

      <section class="keyArea">
        <div class="progressBox">
          <div class="label">Total Progress</div>
          <div class="big" id="total">60%</div>
          <span class="btnTiny">MATCHES</span>
        </div>

        <div class="barsWrap">
          <div class="barsHeader">
            <span>Current Target Cylinders</span>
            <span id="ukm">UKM-v7.0.8</span>
          </div>
          <button class="restartBtn big" id="restartBtn" type="button">RESTART DECRYPTION</button>
          <div class="bars" id="bars">
            <div class="barsPart" data-part="A"><div class="barsGrid" id="barsA"></div></div>
            <div class="barsPart" data-part="B"><div class="barsGrid" id="barsB"></div></div>
            <div class="barsPart" data-part="C"><div class="barsGrid" id="barsC"></div></div>
            <div class="barsPart" data-part="D"><div class="barsGrid" id="barsD"></div></div>
          </div>
          <div class="puzzleHud" id="puzzleHud">DECRYPTING… Align cylinders <b id="puzzleCount">0/54</b></div>
          <div class="clusterUnder" id="clusterUnder">
            <div class="clusterMini">
              <div class="name">Cluster-A</div>
              <div class="state" id="c1">Decrypting Stage 04B</div>
            </div>
            <div class="clusterMini">
              <div class="name">Cluster-B</div>
              <div class="state" id="c2">Decrypting Stage 04B</div>
            </div>
            <div class="clusterMini">
              <div class="name">Cluster-C</div>
              <div class="state" id="c3">Decrypting Stage 04B</div>
            </div>
            <div class="clusterMini">
              <div class="name">Cluster-D</div>
              <div class="state" id="c4">Decrypting Stage 04B</div>
            </div>
          </div>

        </div>
      </section>
</div>

      <div class="footer">
        <span id="footerLeft">SESSION: ACTIVE / AUTH: RESTRICTED</span>
        <span id="footerRight">OPS / MISSION TEAM 01</span>
      </div>
      <!-- SYSTEM UNLOCKED overlay -->
      <div class="unlockOverlay" id="unlockOverlay" aria-hidden="true">
        <div class="unlockPanel" role="dialog" aria-label="system unlocked">
          <div class="achiral ach1">MAGI<br><b>Achiral 1</b><br><small>Operational</small></div>
          <div class="achiral ach2">MAGI<br><b>Achiral 2</b><br><small>Operational</small></div>
          <div class="achiral ach3">MAGI<br><b>Achiral 3</b><br><small>Operational</small></div>

          <div class="unlockMain">
            <div class="unlockTitle">SYSTEM UNLOCKED</div>
            <div class="unlockSub">Anti-L Shielding System Control: Online</div>
          </div>

          <div class="unlockFoot">CODE: 666  Anti-L Shielding System Control</div>
        </div>
      </div>


    </section>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function pad3(n){ return String(n).padStart(3,"0"); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function bits(n=16){
      const s=[];
      for(let i=0;i<n;i++) s.push(String(rnd(0,1)));
      return s.join(" ");
    }
    function dots(t){ return ".".repeat((t%4)+1); }

    function fillBits(targetId){
      const box = $(targetId);
      if(!box) return;
      box.innerHTML = "";
      for(let i=0;i<8;i++){
        const code = document.createElement("code");
        code.textContent = bits(8);
        box.appendChild(code);
      }
    }


    // ========= scale-to-fit (no scrollbars) =========
    function fitConsole(){
      const frame = document.querySelector(".frame");
      if(!frame) return;
      const margin = 0; // fullscreen fit
      const w = frame.offsetWidth;
      const h = frame.offsetHeight;
      const sx = (window.innerWidth - margin*2) / w;
      const sy = (window.innerHeight - margin*2) / h;
      const sc = Math.max(0.35, Math.min(3, sx, sy));
      document.documentElement.style.setProperty("--uiScale", sc.toFixed(3));
    }
    window.addEventListener("resize", fitConsole, {passive:true});
    window.addEventListener("load", fitConsole);
    // ========= Bars (base UI + puzzle) =========
    const bars = $("bars");
    const barGrids = [ $("barsA"), $("barsB"), $("barsC"), $("barsD") ];
    const PART_COUNTS = [14,14,13,13];
    const N = PART_COUNTS.reduce((a,b)=>a+b,0);
    const STEPSY = [-48,-32,-16,0,16,32,48];
    const BOX_CENTER = 96;
    const KEY_CINE = "MAGI_STAGE_CINEMATIC";
    const KEY_SOLVED = "MAGI_STAGE_SOLVED";
    const KEY_DEBUG_SOLVE = "MAGI_DEBUG_SOLVE";
    const BASE_PCT = 37;

    // puzzle state (cylinders) is declared below

    // tiny beep (no asset dependency)
    let ac;
    function beep(freq=880, ms=60, type="square", gain=0.03){
      try {
        ac = ac || new (window.AudioContext || window.webkitAudioContext)();
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g); g.connect(ac.destination);
        o.start();
        setTimeout(() => { try{o.stop();}catch(e){} }, ms);
      } catch(e){}
    }


    const cylEls = [];
    const boxEls = [];
    const slotEls = [];
    const MIN_Y = -56;
    const MAX_Y = 56;
    const SNAP_PX = 5;

    let targetsY = new Array(N).fill(0);
    let posY = new Array(N).fill(0);
    let locked = new Array(N).fill(false);
    let activeIndex = 0;
    let puzzleActive = false;

    function nearestStepY(y){
      let best = STEPSY[0], bestD = 1e9;
      for(const s of STEPSY){
        const d = Math.abs(s - y);
        if(d < bestD){ bestD = d; best = s; }
      }
      return best;
    }

    
    function partOf(i){
      let acc = 0;
      for(let p=0;p<PART_COUNTS.length;p++){
        acc += PART_COUNTS[p];
        if(i < acc) return p;
      }
      return PART_COUNTS.length - 1;
    }

    function makeBars(){
      if(!bars) return;

      // clear grids
      for(let p=0;p<barGrids.length;p++){
        const g = barGrids[p];
        if(!g) continue;
        g.innerHTML = "";
        g.style.gridTemplateColumns = `repeat(${PART_COUNTS[p]}, minmax(0, 1fr))`;
      }

      cylEls.length = 0;
      boxEls.length = 0;
      slotEls.length = 0;

      for(let i=0;i<N;i++){
        const p = partOf(i);
        const grid = barGrids[p];
        if(!grid) continue;

        const slot = document.createElement("div");
        slot.className = "slot";

        const cyl = document.createElement("div");
        cyl.className = "cyl" + (Math.random()<0.30 ? " dim" : "");
        cyl.dataset.i = String(i);

        // inner parts (box-and-whisker feel)
        const stem = document.createElement("i");
        stem.className = "stem";
        const wTop = document.createElement("i");
        wTop.className = "whisker top";
        const wBot = document.createElement("i");
        wBot.className = "whisker bottom";
        const box = document.createElement("i");
        box.className = "box";
        box.dataset.i = String(i);

        const tick = document.createElement("div");
        tick.className = "tick";
        for(let t=0;t<4;t++){ tick.appendChild(document.createElement("i")); }

        cyl.appendChild(stem);
        cyl.appendChild(wTop);
        cyl.appendChild(wBot);
        cyl.appendChild(box);
        cyl.appendChild(tick);

        // initial visual (non-puzzle): random box position
        box.style.top = (BOX_CENTER + rnd(-48,48)) + "px";

        slot.appendChild(cyl);
        grid.appendChild(slot);

        slotEls.push(slot);
        cylEls.push(cyl);
        boxEls.push(box);
      }
    }

    function calcRank(p){
      if(p>=85) return "S";
      if(p>=70) return "A";
      if(p>=55) return "B";
      if(p>=35) return "C";
      return "D";
    }

    function setActive(i){
      for(const el of cylEls) el.classList.remove("active");
      if(i < 0 || i >= N) return;
      if(locked[i]) return;
      cylEls[i].classList.add("active");
      activeIndex = i;
    }

    function setPuzzleHud(){
      const c = locked.filter(Boolean).length;
      const cnt = $("puzzleCount");
      if(cnt) cnt.textContent = `${c}/${N}`;
    }

    function setPct(p){
      const v = clamp(Math.round(p), 0, 100);
      $("pct").textContent = pad3(v);
      $("total").textContent = `${v}%`;
      $("rank").textContent = calcRank(v);
    }

    function updateProgress(){
      const c = locked.filter(Boolean).length;
      const p = (c>=N) ? 100 : (BASE_PCT + (100-BASE_PCT) * (c / N));
      setPct(p);
      if($("statusRight")){
        $("statusRight").textContent = (c>=N) ? "AI SYSTEMS: UNLOCKED" : "AI SYSTEMS: LOCKED";
        if(c>=N){
          $("statusRight").style.borderColor = "rgba(57,255,122,.55)";
          $("statusRight").style.color = "var(--green)";
        }
      }
      setPuzzleHud();
    }

    function applyPos(i){
      const b = boxEls[i];
      if(!b) return;
      b.style.top = (BOX_CENTER + posY[i]) + "px";
    }

    function lockCyl(i){
      if(locked[i]) return;
      locked[i] = true;
      posY[i] = targetsY[i];
      applyPos(i);

      const el = cylEls[i];
      el.classList.add("locked");
      el.classList.remove("active");
      beep(980, 45, "square", 0.03);

      // advance
      let j = i + 1;
      while(j < N && locked[j]) j++;
      if(j < N) setActive(j);
      updateProgress();

      if(locked.filter(Boolean).length >= N){
        puzzleActive = false;
        sessionStorage.setItem(KEY_SOLVED, "1");
        showUnlocked();
      }
    }

    function enablePuzzle(){
      // choose target offsets
      targetsY = targetsY.map(()=> STEPSY[rnd(0, STEPSY.length-1)]);
      locked = new Array(N).fill(false);

      for(let i=0;i<N;i++){
        let y = STEPSY[rnd(0, STEPSY.length-1)];
        if(y === targetsY[i] && Math.random() < 0.75){
          y = STEPSY[(STEPSY.indexOf(y)+rnd(1, STEPSY.length-1)) % STEPSY.length];
        }
        posY[i] = y;
        const el = cylEls[i];
        el.classList.remove("locked","active");
        applyPos(i);
      }

      puzzleActive = true;
      setActive(0);
      updateProgress();

      // drag logic (active cyl only)
      let drag = null; // {i, startY, startPos}
      function onDown(e){
        if(!puzzleActive) return;
        const i = parseInt(this.dataset.i || "-1", 10);
        if(i !== activeIndex) return;
        if(locked[i]) return;

        drag = {i, startY: e.clientY, startPos: posY[i]};
        this.setPointerCapture?.(e.pointerId);
        beep(660, 30, "square", 0.02);
        e.preventDefault();
      }
      function onMove(e){
        if(!drag) return;
        const i = drag.i;
        const dy = (e.clientY - drag.startY);
        posY[i] = clamp(drag.startPos + dy, MIN_Y, MAX_Y);
        applyPos(i);
      }
      function onUp(e){
        if(!drag) return;
        const i = drag.i;
        const snap = nearestStepY(posY[i]);
        posY[i] = snap;
        applyPos(i);
        drag = null;

        if(snap === targetsY[i]){
          lockCyl(i);
        } else {
          beep(220, 80, "sawtooth", 0.02);
        }
      }

      for(const el of boxEls){
        el.onpointerdown = onDown;
        el.onpointermove = onMove;
        el.onpointerup = onUp;
        el.onpointercancel = onUp;
      }
    }

    function solvePuzzle(){
      if(!puzzleActive) return;
      for(let i=0;i<N;i++){
        if(locked[i]) continue;
        posY[i] = targetsY[i];
        applyPos(i);
        lockCyl(i);
      }
    }
    function showUnlocked(){
      const o = $("unlockOverlay");
      if(o){
        o.classList.add("on");
        o.setAttribute("aria-hidden","false");
      }
      setPct(100);
      if($("statusRight")){
        $("statusRight").textContent = "AI SYSTEMS: UNLOCKED";
        $("statusRight").style.borderColor = "rgba(57,255,122,.55)";
        $("statusRight").style.color = "var(--green)";
      }
      beep(1320, 70, "square", 0.03);
      setTimeout(()=>beep(1760, 80, "square", 0.03), 90);
    }

    // ========= Config (existing) =========
    const sweep = document.getElementById("sweep");
    let ang = 0;

    const THEATER_LABEL = {
      EU:"EUROPE", JP:"JAPAN", NA:"NORTH AMERICA", SA:"SOUTH AMERICA",
      AF:"AFRICA", ME:"MIDDLE EAST", OC:"OCEANIA", PAC:"PACIFIC", GLOBAL:"GLOBAL"
    };

    function readQuery(){
      const sp = new URLSearchParams(location.search);
      const theater = (sp.get("theater") || "EU").toUpperCase();
      const pillar = parseInt(sp.get("pillar") || "1", 10);
      const mode = (sp.get("mode") || "RESTORE").toUpperCase();
      return {
        theater: THEATER_LABEL[theater] ? theater : "EU",
        pillar: isFinite(pillar) ? clamp(pillar,1,99) : 1,
        mode: ["RESTORE","RESEAL","STABILIZE","DIAG"].includes(mode) ? mode : "RESTORE"
      };
    }

    function applyConfig(cfg){
      $("theater").value = cfg.theater;
      $("pillarNo").value = cfg.pillar;
      $("mode").value = cfg.mode;

      const th = cfg.theater;
      const thLabel = THEATER_LABEL[th] || th;
      const pNo = pad2(cfg.pillar);

      $("keyMeta").textContent = `BLACK VAULT / THEATER ${th} / SEALING PILLAR No.${pNo}`;
      $("sideGreen").textContent = `L-3E / ${th}-OPS / ACCESS: RESTRICTED`;

      const modeLabel = ({
        RESTORE:"RESTORATION",
        RESEAL:"RE-SEALING",
        STABILIZE:"STABILIZATION",
        DIAG:"DIAGNOSTICS"
      })[cfg.mode] || "RESTORATION";

      $("topbarLeft").textContent = `AM-4 / ${modeLabel} CONTROL / SEALING PILLAR`;
      $("subline").textContent = `${modeLabel} SYSTEM CONTROL // NODE INTERLOCK // TELEMETRY FEED`;

      $("statusLeft").textContent = (cfg.mode==="DIAG") ? "INTERLINK: TESTING" : "INTERLINK: NOMINAL";
      $("footerRight").textContent = `${thLabel} / MISSION TEAM ${pNo}`;
      document.title = `Sealing Pillar Console [${th}-No.${pNo}]`;

      $("ukm").textContent = `UKM-v7.${rnd(0,9)}.${rnd(0,9)}`;

      const sp = new URLSearchParams(location.search);
      sp.set("theater", th);
      sp.set("pillar", String(cfg.pillar));
      sp.set("mode", cfg.mode);
      history.replaceState(null, "", `${location.pathname}?${sp.toString()}`);
    }

    function currentCfg(){
      return {
        theater: $("theater").value,
        pillar: clamp(parseInt($("pillarNo").value || "1",10),1,99),
        mode: $("mode").value
      };
    }

    function exportConfig(cfg){
      const blob = new Blob([JSON.stringify({
        system:"sealing-pillar-console",
        theater: cfg.theater,
        pillar: cfg.pillar,
        mode: cfg.mode,
        exported_at: new Date().toISOString()
      }, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      const pNo = pad2(cfg.pillar);
      a.href = URL.createObjectURL(blob);
      a.download = `pillar-${cfg.theater.toLowerCase()}-no${pNo}-${cfg.mode.toLowerCase()}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }

    // ========= init =========
    makeBars();
    applyConfig(readQuery());
    ["bits1","bits2","bits3","bits4"].forEach(fillBits);

    // base percent like reference
    setPct(BASE_PCT);

    $("apply").addEventListener("click", ()=>{
      applyConfig(currentCfg());
      $("chipLink").textContent = "LINK*";
      setTimeout(()=>{ $("chipLink").textContent = "LINK"; }, 350);
    });

    // overlay dismiss
    $("unlockOverlay")?.addEventListener("click", ()=>{
      const o = $("unlockOverlay");
      if(!o) return;
      o.classList.remove("on");
      o.setAttribute("aria-hidden","true");
    });

    // restart button -> start puzzle
    const restartBtn = $("restartBtn");
    if(restartBtn){
      restartBtn.addEventListener("click", ()=>{
        if(puzzleActive) return;
        restartBtn.disabled = true;
        enablePuzzle();

        // debug flag auto-solve
        if(sessionStorage.getItem(KEY_DEBUG_SOLVE) === "1"){
          sessionStorage.removeItem(KEY_DEBUG_SOLVE);
          setTimeout(()=>solvePuzzle(), 220);
        }
      });
    }

    // Konami debug: ↑↑↓↓←→←→ba
    const KONAMI = ["ArrowUp","ArrowUp","ArrowDown","ArrowDown","ArrowLeft","ArrowRight","ArrowLeft","ArrowRight","b","a"];
    const buf = [];
    window.addEventListener("keydown", (e)=>{
      if(e.shiftKey && (e.key==="E" || e.key==="e")){
        exportConfig(currentCfg());
        return;
      }
      let k = e.key;
      if(k.length === 1) k = k.toLowerCase();
      buf.push(k);
      while(buf.length > KONAMI.length) buf.shift();
      const ok = KONAMI.every((v,idx)=>buf[idx]===v);
      if(ok){
        if(puzzleActive && sessionStorage.getItem(KEY_SOLVED) !== "1"){
          solvePuzzle();
        } else {
          sessionStorage.setItem(KEY_DEBUG_SOLVE, "1");
        }
      }
    });

    // ========= cinematic flow =========
    const solved = sessionStorage.getItem(KEY_SOLVED) === "1";
    const cinematic = sessionStorage.getItem(KEY_CINE) === "1";
    if(cinematic && !solved){
      sessionStorage.removeItem(KEY_CINE);
      document.body.classList.add("cinematic");

      setTimeout(()=>document.body.classList.add("radarShown"), 160);
      setTimeout(()=>document.body.classList.add("pctShown"), 560);
      setTimeout(()=>document.body.classList.add("decryptShown"), 1050);

      setTimeout(()=>{
        if(!restartBtn) return;
        if(restartBtn.disabled) return;
        restartBtn.click();
      }, 1700);
    } else {
      document.body.classList.remove("cinematic");
      if(solved){
        if(restartBtn) restartBtn.disabled = true;
        setPct(100);
        if($("statusRight")){
          $("statusRight").textContent = "AI SYSTEMS: UNLOCKED";
          $("statusRight").style.borderColor = "rgba(57,255,122,.55)";
          $("statusRight").style.color = "var(--green)";
        }
      }
    }

    // ========= ambient updates =========
    let tick = 0;
    setInterval(()=>{
      tick++;

      $("t1").textContent = "Decrypting" + dots(tick);
      $("t2").textContent = "Decrypting" + dots(tick+1);
      $("t3").textContent = "Decrypting" + dots(tick+2);
      $("t4").textContent = "Decrypting" + dots(tick+3);

      if(tick % 5 === 0){
        ["bits1","bits2","bits3","bits4"].forEach(fillBits);
      }

      if(tick % 12 === 0){
        $("stageMid").textContent = (Math.random() < .7) ? "STAGE 04" : "STAGE 05";
      }

      if(!puzzleActive && !solved){
        for(let i=0;i<cylEls.length;i++){
          if(locked[i]) continue;
          posY[i] = clamp(posY[i] + rnd(-2,2), MIN_Y, MAX_Y);
          applyPos(i);
        }
      }

      const states = ["Decrypting Stage 04B","Stage Locked","Nominal Sync","Interlock Pending","Key Match: Partial"];
      ["c1","c2","c3","c4"].forEach((id)=>{
        if(Math.random()<0.25) $(id).textContent = states[rnd(0,states.length-1)];
      });

      ang = (ang + 8) % 360;
      if(sweep) sweep.setAttribute("transform", `rotate(${ang} 0 0)`);
    }, 650);
  </script>
</body>
</html>
